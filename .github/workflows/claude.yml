name: Claude Code
on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request:
    types: [opened, ready_for_review]

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write
  actions: read

jobs:
  claude:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event_name != 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.2
        with:
          persist-credentials: true

      - name: Setup Node (for MCP servers via npx)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Write MCP config (GitHub only)
        shell: bash
        run: |
          cat > .mcp.json <<'JSON'
          {
            "mcpServers": {
              "github": {
                "command": "npx",
                "args": ["-y", "@anthropic-ai/mcp-server-github"],
                "env": {
                  "GITHUB_TOKEN": "${{ github.token }}"
                }
              }
            }
          }
          JSON

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ github.token }}
          use_commit_signing: "true"
          claude_args: |
            --max-turns 25
            --mcp-config .mcp.json
            --disallowedTools mcp__playwright__*

  claude-review:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event_name == 'pull_request' && (github.event.action == 'ready_for_review' || github.event.pull_request.draft == false)
    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.2
        with:
          persist-credentials: true

      - name: Setup Node (for MCP servers via npx)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Write MCP config (GitHub only)
        shell: bash
        run: |
          cat > .mcp.json <<'JSON'
          {
            "mcpServers": {
              "github": {
                "command": "npx",
                "args": ["-y", "@anthropic-ai/mcp-server-github"],
                "env": {
                  "GITHUB_TOKEN": "${{ github.token }}"
                }
              }
            }
          }
          JSON

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ github.token }}
          use_commit_signing: "true"
          claude_args: |
            --max-turns 25
            --mcp-config .mcp.json
            --disallowedTools mcp__playwright__*
          prompt: |
            Review this pull request for code quality, correctness, and adherence to project conventions.

            Focus on:
            - Correct use of PKHeX.Core APIs (reference https://github.com/kwsch/PKHeX for the source)
            - Adherence to .editorconfig formatting rules and existing code style
            - Potential bugs or regressions
            - Test coverage for new functionality
