@inherits BasePkmdsComponent

@if (Pokemon is not null &&
     AppState is
     {
         SaveFile:
         {
             Context: not
             (EntityContext.None or
             EntityContext.SplitInvalid or
             EntityContext.MaxInvalid),
             Generation: var saveGeneration
         } saveFile,
         SelectedSlotsAreValid: true
     })
{
    <MudGrid Spacing="1">

        @switch (saveFile.GetTrainerIDFormat())
        {
            case TrainerIDFormat.SixteenBit:
            {
                <MudItem xs="6"
                         Class="@ColumnClass">
                    <MudNumericField Label="Trainer ID"
                                     Variant="@Variant.Outlined"
                                     @bind-Value="@Pokemon.TID16"
                                     Format="@AppService.GetIdFormatString()"
                                     For="@(() => Pokemon.TID16)"/>
                </MudItem>

                @if (saveGeneration >= 3)
                {
                    <MudItem xs="6"
                             Class="@ColumnClass">
                        <MudNumericField Label="Trainer SID"
                                         Variant="@Variant.Outlined"
                                         @bind-Value="@Pokemon.SID16"
                                         Format="@AppService.GetIdFormatString(true)"
                                         For="@(() => Pokemon.SID16)"/>
                    </MudItem>
                }
            }
                break;

            case TrainerIDFormat.SixDigit:
            {
                <MudItem xs="6"
                         Class="@ColumnClass">
                    <MudNumericField Label="Trainer ID"
                                     Variant="@Variant.Outlined"
                                     @bind-Value="@Pokemon.TrainerTID7"
                                     Format="@AppService.GetIdFormatString()"
                                     For="@(() => Pokemon.TrainerTID7)"/>
                </MudItem>

                @if (saveGeneration >= 3)
                {
                    <MudItem xs="6"
                             Class="@ColumnClass">
                        <MudNumericField Label="Trainer SID"
                                         Variant="@Variant.Outlined"
                                         @bind-Value="@Pokemon.TrainerSID7"
                                         Format="@AppService.GetIdFormatString(true)"
                                         For="@(() => Pokemon.TrainerSID7)"/>
                    </MudItem>
                }
            }
                break;
        }

        <MudItem xs="6"
                 Class="@ColumnClass">
            <MudTextField Label="OT"
                          Variant="@Variant.Outlined"
                          Text="@Pokemon.OriginalTrainerName"
                          TextChanged="SetPokemonOtName"
                          MaxLength="@saveFile.MaxStringLengthTrainer"
                          For="@(() => Pokemon.OriginalTrainerName)"/>
        </MudItem>

        @if (saveGeneration >= 2)
        {
            <MudItem xs="6"
                     Class="d-flex">
                <GenderDisplayComponent Gender="@((Gender)Pokemon.OriginalTrainerGender)"
                                        OnChange="@OnGenderToggle"/>
            </MudItem>
        }

        <MudItem xs="12">
            <MudButton OnClick="@FillFromGame"
                       Variant="@Variant.Filled"
                       StartIcon="@Icons.Material.Filled.Person"
                       Class="mt-2">
                Fill Trainer info from Game
            </MudButton>
        </MudItem>

        @* EC and Home Tracker first, so OT/HT sections are contiguous below *@
        @if (saveGeneration >= 6)
        {
            <MudItem xs="12">
                <MudDivider Class="my-2"/>
            </MudItem>

            <MudItem xs="6"
                     Class="@ColumnClass">

                <MudNumericField Label="EC"
                                 Variant="@Variant.Outlined"
                                 Min="0U"
                                 Max="@uint.MaxValue"
                                 @bind-Value:get="@Pokemon.EncryptionConstant"
                                 @bind-Value:set="@(newEc => SetPokemonEc(newEc))"
                                 For="@(() => Pokemon.PID)"/>
            </MudItem>

            <MudItem xs="6"
                     Class="@ColumnClass">

                <MudTextField Label="EC (Hex)"
                              Variant="@Variant.Outlined"
                              MaxLength="8"
                              Mask="@Constants.HexMask"
                              @bind-Value:get="@Pokemon.EncryptionConstant.ToString("X8")"
                              @bind-Value:set="@((string newEcHex) => SetPokemonEc(newEcHex))"/>
            </MudItem>

            <MudItem xs="12">
                <MudButton OnClick="@RandomizeEc"
                           Variant="@Variant.Outlined"
                           StartIcon="@Icons.Material.Filled.Shuffle">
                    Randomize EC
                </MudButton>
            </MudItem>
        }

        @if (Pokemon is IHomeTrack homeTrack)
        {
            <MudItem xs="6"
                     Class="@ColumnClass">

                <MudCheckBox Label="Has Home Tracker"
                             Value="@homeTrack.HasTracker"
                             For="@(() => homeTrack.HasTracker)"
                             ReadOnly/>

            </MudItem>

            <MudItem xs="6"
                     Class="@ColumnClass">

                <MudTextField Label="Home Tracker"
                              Variant="@Variant.Outlined"
                              MaxLength="16"
                              Mask="@Constants.HexMask"
                              @bind-Value:get="@homeTrack.Tracker.ToString("X16")"
                              @bind-Value:set="@((string newHomeTrackerHex) => SetPokemonHomeTracker(newHomeTrackerHex))"/>

            </MudItem>
        }

        @* Latest (Not OT) Handler – only relevant for Gen 6+ *@
        @if (saveGeneration >= 6)
        {
            <MudItem xs="12">
                <MudDivider Class="my-2"/>
                <MudText Typo="@Typo.subtitle2"
                         Class="mt-1 mb-1">Latest (Not OT) Handler
                </MudText>
            </MudItem>

            <MudItem xs="6"
                     Class="@ColumnClass">
                <MudTextField Label="Handler Name"
                              Variant="@Variant.Outlined"
                              @bind-Value="@Pokemon.HandlingTrainerName"
                              MaxLength="@saveFile.MaxStringLengthTrainer"/>
            </MudItem>

            <MudItem xs="6"
                     Class="d-flex">
                <GenderDisplayComponent Gender="@((Gender)Pokemon.HandlingTrainerGender)"
                                        OnChange="@(g => Pokemon.HandlingTrainerGender = (byte)g)"/>
            </MudItem>

            @if (Pokemon is IHandlerLanguage htLang)
            {
                <MudItem xs="6"
                         Class="@ColumnClass">
                    <MudSelect T="byte"
                               Label="Handler Language"
                               Variant="@Variant.Outlined"
                               Value="@htLang.HandlingTrainerLanguage"
                               ValueChanged="@(v => htLang.HandlingTrainerLanguage = v)">
                        @foreach (var item in AppService.GetLanguageComboItems(saveGeneration, saveFile.Context))
                        {
                            <MudSelectItem T="byte"
                                           Value="@((byte)item.Value)">@item.Text</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
            }
        }

        @* Friendship *@
        @if (saveGeneration >= 2)
        {
            <MudItem xs="12">
                <MudDivider Class="my-2"/>
            </MudItem>

            <MudItem xs="6"
                     Class="@ColumnClass">
                <MudNumericField T="byte"
                                 Label="OT Friendship"
                                 Variant="@Variant.Outlined"
                                 Min="0"
                                 Max="@byte.MaxValue"
                                 @bind-Value="@Pokemon.OriginalTrainerFriendship"/>
            </MudItem>

            @if (Pokemon is IMemoryHT)
            {
                <MudItem xs="6"
                         Class="@ColumnClass">
                    <MudNumericField T="byte"
                                     Label="HT Friendship"
                                     Variant="@Variant.Outlined"
                                     Min="0"
                                     Max="@byte.MaxValue"
                                     @bind-Value="@Pokemon.HandlingTrainerFriendship"/>
                </MudItem>
            }
        }

        @* Affection (Gen 6-7) *@
        @if (Pokemon is IAffection affection)
        {
            <MudItem xs="6"
                     Class="@ColumnClass">
                <MudNumericField T="byte"
                                 Label="OT Affection"
                                 Variant="@Variant.Outlined"
                                 Min="0"
                                 Max="@byte.MaxValue"
                                 Value="@affection.OriginalTrainerAffection"
                                 ValueChanged="@(v => affection.OriginalTrainerAffection = v)"/>
            </MudItem>

            <MudItem xs="6"
                     Class="@ColumnClass">
                <MudNumericField T="byte"
                                 Label="HT Affection"
                                 Variant="@Variant.Outlined"
                                 Min="0"
                                 Max="@byte.MaxValue"
                                 Value="@affection.HandlingTrainerAffection"
                                 ValueChanged="@(v => affection.HandlingTrainerAffection = v)"/>
            </MudItem>
        }

        @* Fullness and Enjoyment (Gen 6-8) *@
        @if (Pokemon is IFullnessEnjoyment fullnessEnjoyment)
        {
            <MudItem xs="6"
                     Class="@ColumnClass">
                <MudNumericField T="byte"
                                 Label="Fullness"
                                 Variant="@Variant.Outlined"
                                 Min="0"
                                 Max="@byte.MaxValue"
                                 Value="@fullnessEnjoyment.Fullness"
                                 ValueChanged="@(v => fullnessEnjoyment.Fullness = v)"/>
            </MudItem>

            <MudItem xs="6"
                     Class="@ColumnClass">
                <MudNumericField T="byte"
                                 Label="Enjoyment"
                                 Variant="@Variant.Outlined"
                                 Min="0"
                                 Max="@byte.MaxValue"
                                 Value="@fullnessEnjoyment.Enjoyment"
                                 ValueChanged="@(v => fullnessEnjoyment.Enjoyment = v)"/>
            </MudItem>
        }

        @* Sociability (Gen 8 BDSP/PLA) *@
        @if (Pokemon is ISociability sociability)
        {
            <MudItem xs="6"
                     Class="@ColumnClass">
                <MudNumericField T="uint"
                                 Label="Sociability"
                                 Variant="@Variant.Outlined"
                                 Min="0U"
                                 Max="@uint.MaxValue"
                                 Value="@sociability.Sociability"
                                 ValueChanged="@(v => sociability.Sociability = v)"/>
            </MudItem>
        }

        @* Current Handler *@
        @if (Pokemon is IMemoryHT && saveGeneration >= 6)
        {
            <MudItem xs="6"
                     Class="@ColumnClass">
                <MudSelect T="byte"
                           Label="Current Handler"
                           Variant="@Variant.Outlined"
                           Value="@Pokemon.CurrentHandler"
                           ValueChanged="@(v => Pokemon.CurrentHandler = v)">
                    <MudSelectItem T="byte"
                                   Value="@((byte)0)">OT
                    </MudSelectItem>
                    <MudSelectItem T="byte"
                                   Value="@((byte)1)">HT
                    </MudSelectItem>
                </MudSelect>
            </MudItem>
        }

        @* OT Memory (Gen 6+) *@
        @if (Pokemon is IMemoryOT otMemory && CachedMemoryItems is not null && CachedFeelingItems is not null && CachedQualityItems is not null)
        {
            var otArgType = GetMemoryArgType(otMemory.OriginalTrainerMemory);
            var otArgItems = otArgType != MemoryArgType.None
                ? AppService.GetMemoryArgumentComboItems(otArgType, MemoryGen).ToList()
                : null;
            var otPreview = FormatMemoryText(
                otMemory.OriginalTrainerMemory,
                otMemory.OriginalTrainerMemoryVariable,
                otMemory.OriginalTrainerMemoryIntensity,
                otMemory.OriginalTrainerMemoryFeeling,
                Pokemon.OriginalTrainerName,
                CachedMemoryItems,
                CachedQualityItems,
                CachedFeelingItems);

            <MudItem xs="12">
                <MudDivider Class="my-2"/>
                <MudText Typo="@Typo.subtitle2"
                         Class="mt-1 mb-1">OT Memory
                </MudText>
            </MudItem>

            <MudItem xs="12">
                <MudSelect T="byte"
                           Label="Memory"
                           Variant="@Variant.Outlined"
                           FullWidth
                           MaxHeight="300"
                           Value="@otMemory.OriginalTrainerMemory"
                           ValueChanged="@(v => otMemory.OriginalTrainerMemory = v)">
                    @foreach (var item in CachedMemoryItems)
                    {
                        <MudSelectItem T="byte"
                                       Value="@((byte)item.Value)">@item.Text</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            @if (otArgItems is not null)
            {
                <MudItem xs="12">
                    <MudSelect T="ushort"
                               Label="@GetMemoryArgLabel(otArgType)"
                               Variant="@Variant.Outlined"
                               FullWidth
                               MaxHeight="300"
                               Value="@otMemory.OriginalTrainerMemoryVariable"
                               ValueChanged="@(v => otMemory.OriginalTrainerMemoryVariable = v)">
                        @foreach (var item in otArgItems)
                        {
                            <MudSelectItem T="ushort"
                                           Value="@((ushort)item.Value)">@item.Text</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
            }

            <MudItem xs="6"
                     Class="@ColumnClass">
                <MudSelect T="byte"
                           Label="Intensity"
                           Variant="@Variant.Outlined"
                           FullWidth
                           Value="@otMemory.OriginalTrainerMemoryIntensity"
                           ValueChanged="@(v => otMemory.OriginalTrainerMemoryIntensity = v)">
                    @foreach (var item in CachedQualityItems)
                    {
                        <MudSelectItem T="byte"
                                       Value="@((byte)item.Value)">@item.Text</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="6"
                     Class="@ColumnClass">
                <MudSelect T="byte"
                           Label="Feeling"
                           Variant="@Variant.Outlined"
                           FullWidth
                           Value="@otMemory.OriginalTrainerMemoryFeeling"
                           ValueChanged="@(v => otMemory.OriginalTrainerMemoryFeeling = v)">
                    @foreach (var item in CachedFeelingItems)
                    {
                        <MudSelectItem T="byte"
                                       Value="@((byte)item.Value)">@item.Text</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            @if (!string.IsNullOrEmpty(otPreview))
            {
                <MudItem xs="12">
                    <MudText Typo="@Typo.body2"
                             Class="mud-text-secondary pa-2"
                             Style="white-space: pre-wrap; border: 1px solid var(--mud-palette-lines-default); border-radius: 4px;">
                        @otPreview
                    </MudText>
                </MudItem>
            }

            <MudItem xs="12">
                <MudButton OnClick="@ClearOtMemory"
                           Variant="@Variant.Outlined"
                           Color="@Color.Error"
                           Size="@Size.Small"
                           StartIcon="@Icons.Material.Filled.Clear">
                    Clear OT Memory
                </MudButton>
            </MudItem>
        }

        @* HT Memory (Gen 6+) *@
        @if (Pokemon is IMemoryHT htMemory && CachedMemoryItems is not null && CachedFeelingItems is not null && CachedQualityItems is not null)
        {
            var htArgType = GetMemoryArgType(htMemory.HandlingTrainerMemory);
            var htArgItems = htArgType != MemoryArgType.None
                ? AppService.GetMemoryArgumentComboItems(htArgType, MemoryGen).ToList()
                : null;
            var htPreview = FormatMemoryText(
                htMemory.HandlingTrainerMemory,
                htMemory.HandlingTrainerMemoryVariable,
                htMemory.HandlingTrainerMemoryIntensity,
                htMemory.HandlingTrainerMemoryFeeling,
                Pokemon.HandlingTrainerName,
                CachedMemoryItems,
                CachedQualityItems,
                CachedFeelingItems);

            <MudItem xs="12">
                <MudDivider Class="my-2"/>
                <MudText Typo="@Typo.subtitle2"
                         Class="mt-1 mb-1">HT Memory
                </MudText>
            </MudItem>

            <MudItem xs="12">
                <MudSelect T="byte"
                           Label="Memory"
                           Variant="@Variant.Outlined"
                           FullWidth
                           MaxHeight="300"
                           Value="@htMemory.HandlingTrainerMemory"
                           ValueChanged="@(v => htMemory.HandlingTrainerMemory = v)">
                    @foreach (var item in CachedMemoryItems)
                    {
                        <MudSelectItem T="byte"
                                       Value="@((byte)item.Value)">@item.Text</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            @if (htArgItems is not null)
            {
                <MudItem xs="12">
                    <MudSelect T="ushort"
                               Label="@GetMemoryArgLabel(htArgType)"
                               Variant="@Variant.Outlined"
                               FullWidth
                               MaxHeight="300"
                               Value="@htMemory.HandlingTrainerMemoryVariable"
                               ValueChanged="@(v => htMemory.HandlingTrainerMemoryVariable = v)">
                        @foreach (var item in htArgItems)
                        {
                            <MudSelectItem T="ushort"
                                           Value="@((ushort)item.Value)">@item.Text</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
            }

            <MudItem xs="6"
                     Class="@ColumnClass">
                <MudSelect T="byte"
                           Label="Intensity"
                           Variant="@Variant.Outlined"
                           FullWidth
                           Value="@htMemory.HandlingTrainerMemoryIntensity"
                           ValueChanged="@(v => htMemory.HandlingTrainerMemoryIntensity = v)">
                    @foreach (var item in CachedQualityItems)
                    {
                        <MudSelectItem T="byte"
                                       Value="@((byte)item.Value)">@item.Text</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="6"
                     Class="@ColumnClass">
                <MudSelect T="byte"
                           Label="Feeling"
                           Variant="@Variant.Outlined"
                           FullWidth
                           Value="@htMemory.HandlingTrainerMemoryFeeling"
                           ValueChanged="@(v => htMemory.HandlingTrainerMemoryFeeling = v)">
                    @foreach (var item in CachedFeelingItems)
                    {
                        <MudSelectItem T="byte"
                                       Value="@((byte)item.Value)">@item.Text</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            @if (!string.IsNullOrEmpty(htPreview))
            {
                <MudItem xs="12">
                    <MudText Typo="@Typo.body2"
                             Class="mud-text-secondary pa-2"
                             Style="white-space: pre-wrap; border: 1px solid var(--mud-palette-lines-default); border-radius: 4px;">
                        @htPreview
                    </MudText>
                </MudItem>
            }

            <MudItem xs="12">
                <MudButton OnClick="@ClearHtMemory"
                           Variant="@Variant.Outlined"
                           Color="@Color.Error"
                           Size="@Size.Small"
                           StartIcon="@Icons.Material.Filled.Clear">
                    Clear HT Memory
                </MudButton>
            </MudItem>
        }

        @* Geo Locations / Residence (Gen 6/7 IGeoTrack) *@
        @if (Pokemon is IGeoTrack geoTrack)
        {
            var countries = AppService.GetGeoCountryComboItems().ToList();

            <MudItem xs="12">
                <MudDivider Class="my-2"/>
                <MudText Typo="@Typo.subtitle2"
                         Class="mt-1 mb-1">Geo Locations
                </MudText>
            </MudItem>

            @for (var geoSlot = 1; geoSlot <= 5; geoSlot++)
            {
                var slotIndex = geoSlot; // capture for lambdas
                var slotCountry = GetGeoCountry(geoTrack, slotIndex);
                var slotRegions = slotCountry != 0
                    ? AppService.GetGeoRegionComboItems(slotCountry).ToList()
                    : null;
                var slotLabel = slotIndex == 1
                    ? "Latest Country"
                    : $"Past Country {slotIndex - 1}";
                var regionLabel = slotIndex == 1
                    ? "Latest Region"
                    : $"Past Region {slotIndex - 1}";

                <MudItem xs="6"
                         Class="@ColumnClass">
                    <MudSelect T="byte"
                               Label="@slotLabel"
                               Variant="@Variant.Outlined"
                               FullWidth
                               MaxHeight="300"
                               Value="@slotCountry"
                               ValueChanged="@(v => SetGeoCountry(geoTrack, slotIndex, v))">
                        @foreach (var item in countries)
                        {
                            <MudSelectItem T="byte"
                                           Value="@((byte)item.Value)">@item.Text</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                @if (slotRegions is not null)
                {
                    <MudItem xs="6"
                             Class="@ColumnClass">
                        <MudSelect T="byte"
                                   Label="@regionLabel"
                                   Variant="@Variant.Outlined"
                                   FullWidth
                                   MaxHeight="300"
                                   Value="@GetGeoRegion(geoTrack, slotIndex)"
                                   ValueChanged="@(v => SetGeoRegion(geoTrack, slotIndex, v))">
                            @foreach (var item in slotRegions)
                            {
                                <MudSelectItem T="byte"
                                               Value="@((byte)item.Value)">@item.Text</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                }
                else
                {
                    <MudItem xs="6"/>
                }
            }

            <MudItem xs="12">
                <MudButton OnClick="@(() => ClearGeoData(geoTrack))"
                           Variant="@Variant.Outlined"
                           Color="@Color.Error"
                           Size="@Size.Small"
                           StartIcon="@Icons.Material.Filled.Clear">
                    Clear Geo Data
                </MudButton>
            </MudItem>
        }

    </MudGrid>
}
