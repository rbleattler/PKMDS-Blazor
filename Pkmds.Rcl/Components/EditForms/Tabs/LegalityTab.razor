@inherits BasePkmdsComponent

@if (Pokemon is not null &&
     AppState is { SaveFile: { Context: not (EntityContext.None or EntityContext.SplitInvalid or EntityContext.MaxInvalid) }, SelectedSlotsAreValid: true })
{
    @if (Analysis is { } analysis)
    {
        <MudStack Class="pa-2">

            <MudAlert Severity="@(IsLegal
                                    ? Severity.Success
                                    : Severity.Error)"
                      Icon="@(IsLegal
                                ? Icons.Material.Filled.CheckCircle
                                : Icons.Material.Filled.Cancel)">
                @(IsLegal
                    ? "This Pokémon is legal."
                    : "This Pokémon has legality issues.")
            </MudAlert>

            @{
                var issues = analysis.Results
                    .Where(r => !r.Valid)
                    .ToList();
                var invalidMoves = GetInvalidMoves();
                var invalidRelearns = GetInvalidRelearnMoves();
                var totalIssues = issues.Count + invalidMoves.Count + invalidRelearns.Count;
            }

            @if (totalIssues > 0)
            {
                <MudText Typo="@Typo.subtitle2"
                         Class="mt-2">Issues (@totalIssues)
                </MudText>

                <MudList T="string"
                         Dense>
                    @foreach (var result in issues)
                    {
                        <MudListItem T="string"
                                     Icon="@GetSeverityIcon(result.Judgement)"
                                     IconColor="@GetSeverityColor(result.Judgement)"
                                     @key="@($"{result.Identifier}:{result.Result}")">
                            <MudStack Row
                                      AlignItems="@AlignItems.Center"
                                      Spacing="1">
                                <MudChip T="string"
                                         Size="@Size.Small"
                                         Color="@GetSeverityColor(result.Judgement)"
                                         Variant="@Variant.Outlined">
                                    @GetIdentifierLabel(result.Identifier)
                                </MudChip>
                                <MudText Typo="@Typo.body2">@HumanizeResult(result)</MudText>
                            </MudStack>
                        </MudListItem>
                    }
                    @foreach (var (moveResult, slotNum) in invalidMoves)
                    {
                        <MudListItem T="string"
                                     Icon="@GetSeverityIcon(moveResult.Judgement)"
                                     IconColor="@GetSeverityColor(moveResult.Judgement)"
                                     @key="@($"move:{slotNum}")">
                            <MudStack Row
                                      AlignItems="@AlignItems.Center"
                                      Spacing="1">
                                <MudChip T="string"
                                         Size="@Size.Small"
                                         Color="@GetSeverityColor(moveResult.Judgement)"
                                         Variant="@Variant.Outlined">
                                    Move @slotNum
                                </MudChip>
                                <MudText Typo="@Typo.body2">@GetMoveSummary(moveResult)</MudText>
                            </MudStack>
                        </MudListItem>
                    }
                    @foreach (var (relearnResult, slotNum) in invalidRelearns)
                    {
                        <MudListItem T="string"
                                     Icon="@GetSeverityIcon(relearnResult.Judgement)"
                                     IconColor="@GetSeverityColor(relearnResult.Judgement)"
                                     @key="@($"relearn:{slotNum}")">
                            <MudStack Row
                                      AlignItems="@AlignItems.Center"
                                      Spacing="1">
                                <MudChip T="string"
                                         Size="@Size.Small"
                                         Color="@GetSeverityColor(relearnResult.Judgement)"
                                         Variant="@Variant.Outlined">
                                    Relearn @slotNum
                                </MudChip>
                                <MudText Typo="@Typo.body2">@GetMoveSummary(relearnResult)</MudText>
                            </MudStack>
                        </MudListItem>
                    }
                </MudList>
            }

            @if (HasRibbonIssues || HasMoveIssues || HasRelearnMoveIssues || HasBallIssues || HasMetLocationIssues)
            {
                <MudText Typo="@Typo.subtitle2"
                         Class="mt-2">Quick Fixes
                </MudText>
                <MudStack Row
                          Wrap="@Wrap.Wrap"
                          Spacing="1">
                    @if (HasBallIssues)
                    {
                        <MudButton Variant="@Variant.Outlined"
                                   Color="@Color.Warning"
                                   StartIcon="@Icons.Material.Filled.AutoFixHigh"
                                   Size="@Size.Small"
                                   OnClick="@SuggestBall">
                            Suggest Ball
                        </MudButton>
                    }
                    @if (HasMetLocationIssues)
                    {
                        <MudButton Variant="@Variant.Outlined"
                                   Color="@Color.Warning"
                                   StartIcon="@Icons.Material.Filled.AutoFixHigh"
                                   Size="@Size.Small"
                                   OnClick="@SuggestMetLocation">
                            Fix Met Location
                        </MudButton>
                    }
                    @if (HasRibbonIssues)
                    {
                        <MudButton Variant="@Variant.Outlined"
                                   Color="@Color.Warning"
                                   StartIcon="@Icons.Material.Filled.AutoFixHigh"
                                   Size="@Size.Small"
                                   OnClick="@RemoveInvalidRibbons">
                            Remove Invalid Ribbons
                        </MudButton>
                        <MudButton Variant="@Variant.Outlined"
                                   Color="@Color.Info"
                                   StartIcon="@Icons.Material.Filled.EmojiEvents"
                                   Size="@Size.Small"
                                   OnClick="@AddValidRibbons">
                            Add Valid Ribbons
                        </MudButton>
                    }
                    @if (HasMoveIssues || HasEncounterIssues)
                    {
                        <MudButton Variant="@Variant.Outlined"
                                   Color="@Color.Warning"
                                   StartIcon="@Icons.Material.Filled.AutoFixHigh"
                                   Size="@Size.Small"
                                   OnClick="@SuggestMoves">
                            Suggest Moves
                        </MudButton>
                    }
                    @if (HasRelearnMoveIssues)
                    {
                        <MudButton Variant="@Variant.Outlined"
                                   Color="@Color.Warning"
                                   StartIcon="@Icons.Material.Filled.AutoFixHigh"
                                   Size="@Size.Small"
                                   OnClick="@SuggestRelearnMoves">
                            Suggest Relearn Moves
                        </MudButton>
                    }
                </MudStack>
            }

            <MudExpansionPanels>
                <MudExpansionPanel Text="Full Legality Report">
                    <MudText Typo="@Typo.body2"
                             Style="white-space: pre-wrap; font-family: monospace; font-size: 0.75rem;">
                        @analysis.Report(verbose: true)
                    </MudText>
                </MudExpansionPanel>
            </MudExpansionPanels>

        </MudStack>
    }
    else
    {
        <MudText Class="pa-2"
                 Color="@Color.Default">No Pokémon selected.
        </MudText>
    }
}
