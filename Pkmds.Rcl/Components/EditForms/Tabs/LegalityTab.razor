@inherits BasePkmdsComponent

@if (Pokemon is not null &&
     AppState is { SaveFile: { Context: not (EntityContext.None or EntityContext.SplitInvalid or EntityContext.MaxInvalid) }, SelectedSlotsAreValid: true })
{
    @if (Analysis is { } analysis)
    {
        <MudStack Class="pa-2">

            <MudAlert Severity="@(IsLegal ? MudBlazor.Severity.Success : MudBlazor.Severity.Error)"
                      Icon="@(IsLegal ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)">
                @(IsLegal ? "This Pokémon is legal." : "This Pokémon has legality issues.")
            </MudAlert>

            @{
                var issues = analysis.Results
                    .Where(r => !r.Valid)
                    .ToList();
            }

            @if (issues.Count > 0)
            {
                <MudText Typo="@Typo.subtitle2" Class="mt-2">Issues (@issues.Count)</MudText>

                <MudList T="CheckResult" Dense>
                    @foreach (var result in issues)
                    {
                        <MudListItem T="CheckResult"
                                     Icon="@GetSeverityIcon(result.Judgement)"
                                     IconColor="@GetSeverityColor(result.Judgement)"
                                     @key="@($"{result.Identifier}:{result.Result}")">
                            <MudStack Row AlignItems="@AlignItems.Center" Spacing="1">
                                <MudChip T="string"
                                         Size="@Size.Small"
                                         Color="@GetSeverityColor(result.Judgement)"
                                         Variant="@Variant.Outlined">
                                    @GetIdentifierLabel(result.Identifier)
                                </MudChip>
                                <MudText Typo="@Typo.body2">@HumanizeResult(result)</MudText>
                            </MudStack>
                        </MudListItem>
                    }
                </MudList>

                @if (HasRibbonIssues || HasMoveIssues || HasRelearnMoveIssues || HasBallIssues || HasMetLocationIssues)
                {
                    <MudText Typo="@Typo.subtitle2" Class="mt-2">Quick Fixes</MudText>
                    <MudStack Row Wrap="@Wrap.Wrap" Spacing="1">
                        @if (HasBallIssues)
                        {
                            <MudButton Variant="@Variant.Outlined"
                                       Color="@Color.Warning"
                                       StartIcon="@Icons.Material.Filled.AutoFixHigh"
                                       Size="@Size.Small"
                                       OnClick="@SuggestBall">
                                Suggest Ball
                            </MudButton>
                        }
                        @if (HasMetLocationIssues)
                        {
                            <MudButton Variant="@Variant.Outlined"
                                       Color="@Color.Warning"
                                       StartIcon="@Icons.Material.Filled.AutoFixHigh"
                                       Size="@Size.Small"
                                       OnClick="@SuggestMetLocation">
                                Fix Met Location
                            </MudButton>
                        }
                        @if (HasRibbonIssues)
                        {
                            <MudButton Variant="@Variant.Outlined"
                                       Color="@Color.Warning"
                                       StartIcon="@Icons.Material.Filled.AutoFixHigh"
                                       Size="@Size.Small"
                                       OnClick="@RemoveInvalidRibbons">
                                Remove Invalid Ribbons
                            </MudButton>
                            <MudButton Variant="@Variant.Outlined"
                                       Color="@Color.Info"
                                       StartIcon="@Icons.Material.Filled.EmojiEvents"
                                       Size="@Size.Small"
                                       OnClick="@AddValidRibbons">
                                Add Valid Ribbons
                            </MudButton>
                        }
                        @if (HasMoveIssues)
                        {
                            <MudButton Variant="@Variant.Outlined"
                                       Color="@Color.Warning"
                                       StartIcon="@Icons.Material.Filled.AutoFixHigh"
                                       Size="@Size.Small"
                                       OnClick="@SuggestMoves">
                                Suggest Moves
                            </MudButton>
                        }
                        @if (HasRelearnMoveIssues)
                        {
                            <MudButton Variant="@Variant.Outlined"
                                       Color="@Color.Warning"
                                       StartIcon="@Icons.Material.Filled.AutoFixHigh"
                                       Size="@Size.Small"
                                       OnClick="@SuggestRelearnMoves">
                                Suggest Relearn Moves
                            </MudButton>
                        }
                    </MudStack>
                }
            }

            <MudExpansionPanels>
                <MudExpansionPanel Text="Full Legality Report">
                    <MudText Typo="@Typo.body2"
                             Style="white-space: pre-wrap; font-family: monospace; font-size: 0.75rem;">
                        @analysis.Report(verbose: true)
                    </MudText>
                </MudExpansionPanel>
            </MudExpansionPanels>

        </MudStack>
    }
    else
    {
        <MudText Class="pa-2" Color="@Color.Default">No Pokémon selected.</MudText>
    }
}
